<div class="game-container">
  <div class="game-area" *ngIf="gameStarted; else startScreen" #gameArea>
    <div
      class="game-field"
      [style.width.px]="worldWidth"
      [style.height.px]="worldHeight"
      [style.transform]="cameraTransform"
    >
      <!-- Players -->
      <!-- Players -->
      <div
        *ngFor="let player of players"
        class="tank"
        [style.left.px]="player.x - 25"
        [style.top.px]="player.y - 25"
        [class.current-player]="player.id === currentPlayer?.id"
      >
        <!-- Tank Rotator (Body + Cannon) -->
        <div
          class="tank-rotator"
          [style.transform]="
            'rotate(' + ((player.angle * 180) / Math.PI + 90) + 'deg)'
          "
        >
          <div class="tank-cannon"></div>
          <div class="tank-cannon rear" *ngIf="player.stats.rearGuard"></div>
          <div class="tank-body" [style.background-color]="player.color"></div>
        </div>

        <!-- HP Bar (Only for current player) -->
        <div class="hp-bar-container" *ngIf="player.id === currentPlayer?.id">
          <div
            class="hp-bar"
            [style.width.%]="(player.hp / player.maxHp) * 100"
          ></div>
        </div>

        <!-- Immunity Shield -->
        <div class="immunity-shield" *ngIf="isImmune(player)"></div>
      </div>

      <!-- Obstacles -->
      <div
        *ngFor="let o of obstacles"
        class="obstacle"
        [style.left.px]="o.x"
        [style.top.px]="o.y"
        [style.width.px]="o.width"
        [style.height.px]="o.height"
      ></div>

      <!-- Bullets -->
      <div 
        *ngFor="let bullet of bullets" 
        class="bullet"
        [style.left.px]="bullet.x - 4"
        [style.top.px]="bullet.y - 4"
      ></div>

      <!-- Orbs -->
      <div 
        *ngFor="let orb of orbs" 
        class="orb"
        [style.left.px]="orb.x - 5"
        [style.top.px]="orb.y - 5"
      ></div>
      <!-- Enemies -->
      <div
        *ngFor="let enemy of enemies; trackBy: trackByFn"
        class="enemy"
        [style.left.px]="enemy.x - enemy.size/2"
        [style.top.px]="enemy.y - enemy.size/2"
        [style.width.px]="enemy.size"
        [style.height.px]="enemy.size"
      >
          <div class="enemy-hp-bar">
              <div class="enemy-hp-fill" [style.width.%]="(enemy.hp / enemy.maxHp) * 100"></div>
          </div>
      </div>
    </div>

    <div class="controls">
      <h3>Controls:</h3>
      <p>WASD - Move</p>
      <p>Mouse - Aim</p>
      <p>Space - Shoot</p>
    </div>

    <div class="game-info">
      <h2>ðŸŽ® Tiny Tanks Time</h2>
      <p>Players: {{ players.length }}</p>
      <p>Bullets: {{ bullets.length }}</p>
      <button (click)="triggerDebugLevelUp()" style="margin-top:10px; padding: 5px 10px; background: #ff4757; color: white; border: none; border-radius: 4px; cursor: pointer; pointer-events: auto; position: relative; z-index: 200;">
        DEBUG: Level Up
      </button>
    </div>

    <!-- EXP Bar -->
    <div class="exp-container" *ngIf="currentPlayer">
      <div class="level-badge">Lvl {{ currentPlayer.level }}</div>
      <div class="exp-bar-bg">
        <div
          class="exp-bar-fill"
          [style.width.%]="(currentPlayer.exp / currentPlayer.maxExp) * 100"
        ></div>
      </div>
    </div>

    <!-- Level Up Modal -->
    <div class="level-up-modal" *ngIf="levelUpOptions">
      <h2>LEVEL UP!</h2>
      <div class="cards-container">
        <div 
          *ngFor="let upgrade of levelUpOptions; let i = index" 
          class="upgrade-card"
          [class.common]="upgrade.rarity === 'Common'"
          [class.rare]="upgrade.rarity === 'Rare'"
          [class.epic]="upgrade.rarity === 'Epic'"
          [class.legendary]="upgrade.rarity === 'Legendary'"
          (click)="selectUpgrade(upgrade)"
          tabindex="0"
          role="button"
        >
          <div class="key-hint">{{ i + 1 }}</div>
          <div class="rarity-label">{{ upgrade.rarity }}</div>
          <h3>{{ upgrade.name }}</h3>
          <p>{{ upgrade.description }}</p>
        </div>
      </div>
    </div>
  </div>

  <ng-template #startScreen>
    <div class="start-screen">
      <h2>Welcome to Tiny Tanks Time!</h2>
      <p>A real-time multiplayer tank battle game</p>
      <button (click)="startGame()" class="start-button">Start Game</button>
      <div class="instructions">
        <h3>How to Play:</h3>
        <ul>
          <li>Use WASD or Arrow Keys to move your tank</li>
          <li>Press Space to shoot bullets</li>
          <li>Try to avoid other players' bullets</li>
          <li>Have fun battling with friends!</li>
        </ul>
      </div>
    </div>
  </ng-template>
</div>
